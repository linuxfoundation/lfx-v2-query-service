# lfx-v2-query-service

HTTP service for LFX API consumers to perform access-controlled queries for LFX resources, including typeahead and full-text search.

## Architecture Overview

The implementation follows the clean architecture principles where:
- **Domain Layer**: Contains business logic and interfaces
- **Service Layer**: Orchestrates business operations
- **Infrastructure Layer**: Implements external dependencies
- **Presentation Layer**: Handles HTTP/API concerns (generated by Goa)

## Directory Structure

```
├── internal/
│   ├── domain/
│   │   └── interfaces.go          # Domain interfaces and models
│   ├── service/
│   │   └── resource_service.go    # Business logic layer
│   └── infrastructure/
│       ├── opensearch/
│       │   ├── templates.go       # OpenSearch query templates
│       │   ├── searcher.go        # OpenSearch implementation
│       │   └── client.go          # HTTP client for OpenSearch
│       └── mock/
│           └── searcher.go        # Mock implementation for testing
├── cmd/query_svc/
│   └── main.go                    # Dependency injection and startup
└── query_svc.go                   # Goa service implementation
```

## Key Components

### Domain Layer (`internal/domain/`)
- **ResourceSearcher Interface**: Defines the contract for resource search operations
- **Domain Models**: Pure business entities without infrastructure dependencies
- **Search Criteria**: Encapsulates search parameters
- **Search Result**: Represents search outcomes

### Service Layer (`internal/service/`)
- **ResourceService**: Contains business logic and validation
- **Validation**: Ensures business rules are enforced
- **Orchestration**: Coordinates between domain and infrastructure layers

### Infrastructure Layer (`internal/infrastructure/`)

#### OpenSearch Implementation
- **templates.go**: Contains OpenSearch query templates for different search scenarios
- **searcher.go**: Implements the ResourceSearcher interface using OpenSearch
- **client.go**: HTTP client for communicating with OpenSearch cluster

#### Mock Implementation
- **searcher.go**: In-memory implementation for testing and development

## Dependency Injection

The clean architecture is wired together in `cmd/query_svc/main.go`:

```go
// Choose implementation based on configuration
var resourceSearcher domain.ResourceSearcher

switch *searchImpl {
case "mock":
    resourceSearcher = mock.NewMockResourceSearcher()
case "opensearch":
    resourceSearcher, err = opensearch.NewOpenSearchSearcherFromConfig(esConfig)
}

// Inject into service
querySvcSvc = querysvcapi.NewQuerySvc(resourceSearcher)
```

## Benefits of This Architecture

1. **Testability**: Easy to swap implementations for testing
2. **Flexibility**: Can easily switch between different search backends
3. **Maintainability**: Clear separation of concerns
4. **Scalability**: Easy to add new search implementations
5. **Independence**: Layers don't depend on external frameworks

## Usage

### Running with Mock Implementation (Default)
```bash
go run cmd/query_svc/main.go -search-impl=mock
```

### Running with OpenSearch
```bash
go run cmd/query_svc/main.go \
    -search-impl=opensearch \
    -es-url=http://localhost:9200 \
    -es-index=lfx-resources \
    -es-username=admin \
    -es-password=admin
```

### Available Command Line Flags

**Search Implementation:**
- `-search-impl`: Choose between "mock" or "opensearch" (default: "mock")

**OpenSearch Configuration:**
- `-es-url`: OpenSearch URL (default: "http://localhost:9200")
- `-es-username`: OpenSearch username
- `-es-password`: OpenSearch password
- `-es-index`: OpenSearch index name (default: "lfx-resources")

**Server Configuration:**
- `-host`: Server host (default: "localhost")
- `-http-port`: HTTP port
- `-debug`: Enable debug logging

### API Usage

The service exposes a RESTful API through the Goa framework:

```
GET /query/resources?name=committee&type=committee&v=1
```

**Parameters:**
- `name`: Resource name or alias (supports typeahead search)
- `type`: Resource type to filter by
- `parent`: Parent resource for hierarchical queries
- `tags`: Array of tags to filter by
- `sort`: Sort order (name_asc, name_desc, updated_asc, updated_desc)
- `page_token`: Pagination token
- `v`: API version (required)

**Response:**
```json
{
  "resources": [
    {
      "type": "committee",
      "id": "123",
      "data": {
        "name": "Technical Advisory Committee",
        "description": "Main technical governance body",
        "status": "active"
      }
    }
  ],
  "page_token": "offset_50",
  "cache_control": "public, max-age=300"
}
```

### OpenSearch Query Templates

The OpenSearch implementation uses template-based queries located in `internal/infrastructure/opensearch/templates.go`:

- **Resource Search Template**: Full-featured search with filtering, sorting, and pagination
- **Typeahead Template**: Optimized for autocomplete scenarios

Templates support:
- Multi-field text search with relevance scoring
- Exact term filtering (type, parent, tags)
- Multiple sort options
- Pagination with search_after
- Highlighting for matched terms

### Testing

The clean architecture makes testing straightforward:

```go
// Use mock implementation for unit tests
searcher := mock.NewMockResourceSearcher()
searcher.AddResource(testResource)

service := service.NewResourceService(searcher)
result, err := service.QueryResources(ctx, criteria)
```

### Extending the Architecture

To add a new search implementation:

1. Create a new package in `internal/infrastructure/`
2. Implement the `domain.ResourceSearcher` interface
3. Add configuration options to `main.go`
4. Update the dependency injection switch statement

## Development

To contribute to this repository:

1. Fork the repository
2. Make your changes
3. Submit a pull request

## License

Copyright The Linux Foundation and each contributor to LFX.

This project’s source code is licensed under the MIT License. A copy of the
license is available in `LICENSE`.

This project’s documentation is licensed under the Creative Commons Attribution
4.0 International License \(CC-BY-4.0\). A copy of the license is available in
`LICENSE-docs`.